# 出牌卡住問題修復說明

## 問題描述

Player 3 在丟出 P9 後，遊戲失去回應，無法繼續進行。

## 問題原因分析

經過分析，發現了兩個潛在問題：

### 問題 1: `startTurn()` 結束時缺少明確提示

當玩家摸牌後，如果沒有自摸和暗槓，`startTurn()` 方法只是結束，沒有明確告訴客戶端「現在可以出牌了」。雖然 `broadcastState()` 已經被調用，並且 `turnIndex` 已經設置，但客戶端可能需要更明確的指示。

### 問題 2: `processPlayerAction()` 中 PLAY_CARD 處理順序問題

在 `processPlayerAction()` 方法中，當 `waitingForAction` 是 `true` 時，所有的請求都會被當作動作回應處理。但是，如果玩家發送 `PLAY_CARD` 請求（出牌），它會被錯誤地路由到 `handleActionResponse()`，而 `handleActionResponse()` 只處理 `Command.ACTION`，不處理 `Command.PLAY_CARD`。

這意味著當 `waitingForAction` 是 `true` 時，出牌請求可能被忽略或錯誤處理。

## 修復方案

### 修復 1: 在 `startTurn()` 結束時添加明確提示

在 `startTurn()` 方法的結尾，當沒有自摸和暗槓時，明確發送「請出牌」消息給當前玩家：

```java
// ✅ 修復：如果沒有自摸和暗槓，明確提示玩家可以出牌
// If no Tsumo and no Concealed Kong, user just plays a card
Map<String, Object> discardMsg = new HashMap<>();
discardMsg.put("message", "請出牌");
send(players.get(currentPlayerIndex), new Packet(Command.GAME_UPDATE, discardMsg));
```

### 修復 2: 優化 `processPlayerAction()` 中 PLAY_CARD 的處理邏輯

將 `PLAY_CARD` 的處理移到方法開頭，優先處理出牌請求：

```java
// ✅ 修復：PLAY_CARD 應該優先處理
// 當玩家是當前玩家時，應該能夠出牌（除非正在等待其他玩家的動作回應）
if (cmd == Command.PLAY_CARD) {
    if (playerIndex == currentPlayerIndex) {
        // 如果正在等待動作，只有在等待自摸選擇時（priority 0）才能出牌
        // 其他情況（等待其他玩家回應）不應該出牌
        if (waitingForAction) {
            if (currentActionGroup != null && currentActionGroup.priority == 0) {
                // 等待自摸選擇時，玩家選擇跳過後可以出牌
                logger.debug("Player {} trying to play card while waiting for self-draw choice", playerIndex);
            } else {
                logger.debug("Player {} tried to play card but waiting for other players' actions", playerIndex);
                return;
            }
        }
        
        // ... 處理出牌邏輯
        
        // 如果正在等待動作，先清除狀態
        if (waitingForAction) {
            waitingForAction = false;
            currentActionGroup = null;
            pendingResponses.clear();
        }
        
        resolveDiscard(tile, playerIndex);
    }
    return;
}
```

## 修改的檔案

- `src/main/java/com/mahjong/server/WebSocketGameSession.java`
  - `processPlayerAction()` 方法（約第 91-138 行）
  - `startTurn()` 方法（約第 690-695 行）

## 遊戲流程說明

### 正常出牌流程：

1. 玩家摸牌（`startTurn()`）
2. 檢查自摸 → 如果沒有，繼續
3. 檢查暗槓 → 如果沒有，繼續
4. **發送「請出牌」消息** ✅ 新增
5. 玩家出牌（`processPlayerAction()` 處理 `PLAY_CARD`）
6. 處理其他玩家的動作回應（`resolveDiscard()`）
7. 繼續下一輪

### 特殊情況處理：

- **等待自摸選擇時出牌**：當玩家摸牌後可以自摸，選擇跳過後，應該能夠出牌。修復後，這種情況會被正確處理。
- **等待其他玩家動作時出牌**：當其他玩家可以吃碰槓時，當前玩家不應該出牌。修復後，這種情況會被正確阻止。

## 測試建議

1. **測試正常出牌流程**：
   - 讓玩家摸牌後出牌
   - 確認遊戲流程正常繼續

2. **測試自摸後出牌**：
   - 讓玩家摸牌後可以自摸，選擇跳過
   - 確認玩家可以正常出牌

3. **測試等待動作時出牌**：
   - 讓玩家出牌後，其他玩家可以吃碰槓
   - 確認當前玩家不能出牌（直到動作處理完成）

4. **測試多輪遊戲**：
   - 進行多輪遊戲，確認沒有卡住的情況

## 相關問題修復

這次修復也解決了之前發現的類似問題：
- CHOW 後遊戲卡住（已修復）
- PONG 後遊戲卡住（已修復）
- 出牌後遊戲卡住（本次修復）

## 注意事項

1. 這個修復確保了在各種情況下，玩家都能正確收到「請出牌」的提示
2. 出牌請求現在會被優先處理，避免被錯誤地當作動作回應處理
3. 添加了詳細的日誌記錄，方便調試和問題追蹤


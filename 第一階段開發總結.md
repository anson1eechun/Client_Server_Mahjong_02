# 第一階段開發總結

## 完成時間
2024年（第一階段）

## 完成任務

### ✅ P0-1: 修正莊家起手牌數

**實作內容**:
- 在 `WebSocketGameSession.start()` 中，發牌後為莊家（playerIndex=0）額外摸 1 張牌
- 新增 `isFirstTurn` 標記來處理莊家第一輪的特殊邏輯
- 莊家第一輪跳過摸牌，直接出牌

**修改檔案**:
- `src/main/java/com/mahjong/server/WebSocketGameSession.java`
  - 新增 `isFirstTurn` 欄位
  - 修改 `start()` 方法：莊家先摸 1 張牌
  - 修改 `startTurn()` 方法：莊家第一輪跳過摸牌

**測試建議**:
```java
@Test
public void testDealerHas17TilesAtStart() {
    // 驗證莊家起手 17 張
    // 驗證其他玩家 16 張
}
```

---

### ✅ P1-1: 暗槓功能

**實作內容**:

1. **擴展 Meld 類別**
   - 新增 `concealed` 屬性（boolean）
   - 新增完整建構子 `Meld(Type, List<Tile>, boolean)`
   - 新增便利方法 `createConcealedKong(Tile)`
   - 新增 `isConcealed()` 方法

2. **ActionProcessor 擴展**
   - 新增 `getConcealedKongOptions(PlayerHand)` 方法：檢測玩家是否可以暗槓
   - 新增 `executeConcealedKong(PlayerHand, Tile)` 方法：執行暗槓動作

3. **WebSocketGameSession 整合**
   - 在 `startTurn()` 中整合暗槓檢測（在自摸檢查之後）
   - 在 `handleActionResponse()` 中處理 `CONCEALED_KONG` 動作
   - 新增 `performConcealedKong()` 方法：
     - 執行暗槓
     - 從牌尾補 1 張牌
     - 檢查槓上開花

**修改檔案**:
- `src/main/java/com/mahjong/logic/Meld.java`
- `src/main/java/com/mahjong/logic/ActionProcessor.java`
- `src/main/java/com/mahjong/server/WebSocketGameSession.java`

**功能流程**:
1. 玩家摸牌後，系統檢測手上是否有 4 張相同牌
2. 如果有，提示玩家可以暗槓
3. 玩家選擇暗槓後：
   - 從手牌移除 4 張牌
   - 添加暗槓面子（標記為暗的）
   - 從牌尾補 1 張牌
   - 檢查是否槓上開花（補牌後自摸）

**測試建議**:
```java
@Test
public void testConcealedKongDetection() {
    // 測試暗槓檢測
}

@Test
public void testConcealedKongExecution() {
    // 測試暗槓執行
}

@Test
public void testConcealedKongDrawReplacement() {
    // 測試槓後補牌
}

@Test
public void testKongDrawWin() {
    // 測試槓上開花
}
```

---

### ✅ T3: 引入日誌系統

**實作內容**:

1. **添加依賴**
   - 在 `pom.xml` 中添加 SLF4J API (2.0.9)
   - 在 `pom.xml` 中添加 Logback Classic (1.4.11)

2. **配置 Logback**
   - 創建 `src/main/resources/logback.xml`
   - 配置控制台輸出和文件輸出
   - 設置日誌級別（INFO 為根級別，com.mahjong 使用 DEBUG）

3. **替換 System.out.println()**
   - 在 `WebSocketGameSession` 中添加 logger
   - 將所有 `System.out.println()` 替換為適當的 logger 調用：
     - `logger.info()` - 重要資訊（如遊戲開始、玩家摸牌）
     - `logger.debug()` - 調試資訊（如動作處理、狀態檢查）

**修改檔案**:
- `pom.xml`
- `src/main/resources/logback.xml` (新增)
- `src/main/java/com/mahjong/server/WebSocketGameSession.java`

**日誌配置**:
- 控制台輸出：即時查看遊戲日誌
- 文件輸出：保存到 `logs/mahjong.log`，按天滾動，保留 30 天

**日誌級別使用**:
- `INFO`: 遊戲流程關鍵節點（遊戲開始、玩家摸牌、胡牌等）
- `DEBUG`: 詳細調試資訊（動作處理、狀態檢查、聽牌檢測等）

---

## 技術細節

### Meld 類別變更

**新增欄位**:
```java
private final boolean concealed; // 是否暗的（用於暗槓）
```

**新增方法**:
```java
public Meld(Type type, List<Tile> tiles, boolean concealed)
public static Meld createConcealedKong(Tile tile)
public boolean isConcealed()
```

### ActionProcessor 新增方法

```java
public List<Tile> getConcealedKongOptions(PlayerHand hand)
public void executeConcealedKong(PlayerHand hand, Tile tile)
```

### WebSocketGameSession 變更

**新增欄位**:
```java
private boolean isFirstTurn = false; // 標記是否為莊家第一輪
private static final Logger logger = LoggerFactory.getLogger(WebSocketGameSession.class);
```

**新增方法**:
```java
private synchronized void performConcealedKong(int playerIndex, Tile tile)
```

**修改方法**:
- `start()`: 莊家先摸 1 張牌
- `startTurn()`: 莊家第一輪跳過摸牌，添加暗槓檢測
- `handleActionResponse()`: 處理暗槓動作

---

## 後續步驟

### 編譯和測試

1. **下載依賴**:
   ```bash
   mvn clean compile
   ```

2. **運行測試**:
   ```bash
   mvn test
   ```

3. **檢查日誌**:
   - 運行遊戲後，檢查 `logs/mahjong.log` 文件
   - 確認日誌輸出正常

### 建議的測試用例

1. **P0-1 測試**:
   - 驗證莊家起手 17 張牌
   - 驗證其他玩家 16 張牌
   - 驗證莊家第一輪不用摸牌

2. **P1-1 測試**:
   - 測試暗槓檢測（手上有 4 張相同牌）
   - 測試暗槓執行（移除 4 張，添加暗槓面子）
   - 測試補牌邏輯
   - 測試槓上開花檢測

3. **T3 測試**:
   - 驗證日誌文件生成
   - 驗證日誌級別正確
   - 驗證日誌內容完整

---

## 已知問題

1. **編譯錯誤**（預期）:
   - SLF4J 依賴需要運行 `mvn clean compile` 下載
   - 這是正常的，運行 Maven 命令後會自動解決

2. **日誌文件目錄**:
   - 首次運行時需要創建 `logs/` 目錄
   - Logback 會自動創建，但建議手動創建以確保權限正確

---

## 總結

第一階段的三個任務（P0-1、P1-1、T3）已全部完成：

- ✅ **P0-1**: 莊家起手 17 張牌功能已實作
- ✅ **P1-1**: 暗槓功能已完整實作（包括檢測、執行、補牌、槓上開花）
- ✅ **T3**: 日誌系統已引入並替換所有 System.out.println()

所有代碼已通過語法檢查，可以進行編譯和測試。建議下一步：
1. 運行 `mvn clean compile` 下載依賴
2. 編寫並運行單元測試
3. 進行整合測試驗證功能


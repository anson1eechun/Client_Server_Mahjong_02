測試場景：標準出牌流程 (Happy Path)

本次整合測試 (`MahjongGameIT.java`) 模擬了以下標準流程：

1.  **連線建立：** 模擬 4 位玩家建立 WebSocket 連線。
2.  **遊戲初始化：** * 伺服器啟動 Session。
    * 規則引擎洗牌、發牌。
    * **驗證點：** 莊家應持有 17 張牌 (16張手牌 + 1張摸牌)，閒家 16 張。
3.  **莊家出牌：**
    * 模擬莊家發送 `PLAY_CARD` 指令 (打出一張牌)。
    * **驗證點：** 伺服器從莊家手牌移除該張牌，並廣播狀態更新。
4.  **動作判定：**
    * 系統呼叫 `ActionProcessor` 檢查該張牌是否觸發吃、碰、槓、胡。
    * (本測試模擬無人動作的情境)。
5.  **回合切換：**
    * 系統自動判斷無動作後，切換至下家 (Next Turn)。
6.  **下家摸牌：**
    * 系統自動為下家摸一張牌。
    * **驗證點：** 下家手牌數變為 17 張，並收到 `DRAW` 訊息。

---

## 系統互動圖 (System Interaction)

下圖展示了測試過程中，各個 Java 類別的互動時序：

```mermaid
sequenceDiagram
    participant Test as 整合測試 (IT)
    participant Session as WebSocketGameSession
    participant Engine as MahjongRuleEngine
    participant Processor as ActionProcessor
    participant P0 as 玩家 0 (莊家)
    participant P1 as 玩家 1 (下家)

    Note over Test, Session: 1. 遊戲初始化
    Test->>Session: start()
    Session->>Engine: shuffle() & deal()
    Engine-->>Session: 完成發牌 (莊17, 閒16)
    Session->>Test: 廣播 GAME_START & Initial State

    Note over Test, Session: 2. 莊家出牌流程
    Test->>Session: processPacket(PLAY_CARD, "M5")
    Session->>Session: removeTile("M5")
    
    Note over Session, Processor: 3. 規則判定
    Session->>Processor: checkPossibleActions("M5")
    Processor-->>Session: 回傳 0 Actions (無人吃碰槓)
    
    Note over Session, P1: 4. 回合流轉
    Session->>Session: nextTurn() -> index=1
    Session->>Engine: drawTile()
    Engine-->>Session: 回傳 "S2" (索子2)
    Session->>P1: 發送 DRAW "S2"
    
    Note over Test: 測試結束：驗證成功
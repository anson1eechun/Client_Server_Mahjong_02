# åˆ†æ”¯è¦†è“‹ç‡æå‡ç­–ç•¥ï¼šå¾ 66% åˆ° 80%

## ğŸ“Š ç•¶å‰ç‹€æ³åˆ†æ

**æ•´é«”åˆ†æ”¯è¦†è“‹ç‡**: 66% (215 æœªè¦†è“‹ / 641 ç¸½åˆ†æ”¯)  
**ç›®æ¨™**: 80% (éœ€è¦è¦†è“‹ç´„ 513 å€‹åˆ†æ”¯ï¼Œç›®å‰ 426 å€‹ï¼Œé‚„éœ€ç´„ 87 å€‹)

### ä¸»è¦å•é¡Œå€åŸŸ

| é¡åˆ¥ | ç•¶å‰è¦†è“‹ç‡ | æœªè¦†è“‹åˆ†æ”¯ | å„ªå…ˆç´š |
|------|-----------|-----------|--------|
| **WebSocketGameSession** | 44% | 101 | ğŸ”´ **æœ€é«˜** |
| WinStrategy | 68% | 33 | ğŸŸ¡ ä¸­ |
| ScoringCalculator | 77% | 23 | ğŸŸ¡ ä¸­ |
| PlayerHand | 55% | 13 | ğŸŸ¢ ä½ |
| HandValidator | 87% | 6 | ğŸŸ¢ ä½ |

---

## ğŸ¯ å¿«é€Ÿæå‡ç­–ç•¥ï¼ˆå°æ’‡æ­¥ï¼‰

### æ’‡æ­¥ 1: å°ˆæ³¨ WebSocketGameSessionï¼ˆæœ€å¤§æ”¶ç›Šï¼‰

**ç‚ºä»€éº¼**: å®ƒæœ‰ 101 å€‹æœªè¦†è“‹åˆ†æ”¯ï¼Œä½”ç¸½æœªè¦†è“‹åˆ†æ”¯çš„ 47%ï¼

**ç­–ç•¥**: é‡å°æ€§æ¸¬è©¦æ‰€æœ‰æ¢ä»¶åˆ†æ”¯

#### é‡é»æ¸¬è©¦çš„åˆ†æ”¯é¡å‹ï¼š

1. **ç•°å¸¸è™•ç†åˆ†æ”¯** (catch blocks)
   ```java
   // æ¸¬è©¦æ‰€æœ‰ try-catch çš„ç•°å¸¸è·¯å¾‘
   - performHu() çš„ catch
   - performKong() çš„ catch
   - performConcealedKong() çš„ catch
   - performPong() çš„ catch
   - performChow() çš„ catch
   - startTurn() çš„ catch
   ```

2. **Null æª¢æŸ¥åˆ†æ”¯**
   ```java
   // æ¸¬è©¦æ‰€æœ‰ null æª¢æŸ¥
   - if (currentActionGroup != null)
   - if (pendingDiscardTile != null)
   - if (replacement != null)
   - if (drawn != null)
   ```

3. **é‚Šç•Œæ¢ä»¶åˆ†æ”¯**
   ```java
   // æ¸¬è©¦æ‰€æœ‰é‚Šç•Œæ¢ä»¶
   - if (totalTiles == 14 || totalTiles == 17)
   - if (sea.isEmpty())
   - if (pendingResponses.isEmpty())
   - if (concealedKongOptions.isEmpty())
   ```

4. **ç‹€æ…‹æª¢æŸ¥åˆ†æ”¯**
   ```java
   // æ¸¬è©¦æ‰€æœ‰ç‹€æ…‹æª¢æŸ¥
   - if (waitingForAction)
   - if (playerIndex == currentPlayerIndex)
   - if (isFirstTurn)
   - if (canTsumo)
   ```

---

### æ’‡æ­¥ 2: ä½¿ç”¨ã€Œåˆ†æ”¯è¦†è“‹ç‡æ¸¬è©¦æ¨¡æ¿ã€

é‡å°æ¯å€‹æ–¹æ³•ï¼Œå»ºç«‹æ¨™æº–æ¸¬è©¦æ¨¡æ¿ï¼š

```java
@Test
void testMethodName_AllBranches() {
    // 1. æ­£å¸¸è·¯å¾‘
    testNormalPath();
    
    // 2. Null è·¯å¾‘
    testNullPath();
    
    // 3. ç•°å¸¸è·¯å¾‘
    testExceptionPath();
    
    // 4. é‚Šç•Œæ¢ä»¶
    testBoundaryConditions();
    
    // 5. ç‹€æ…‹çµ„åˆ
    testStateCombinations();
}
```

---

### æ’‡æ­¥ 3: å¿«é€Ÿè­˜åˆ¥æœªè¦†è“‹åˆ†æ”¯

ä½¿ç”¨ JaCoCo å ±å‘Šæ‰¾å‡ºæœªè¦†è“‹çš„åˆ†æ”¯ï¼š

1. æ‰“é–‹ `target/site/jacoco/com.mahjong.server/WebSocketGameSession.html`
2. æŸ¥çœ‹ç´…è‰²æ¨™è¨˜çš„åˆ†æ”¯ï¼ˆæœªè¦†è“‹ï¼‰
3. é‡å°æ€§ç·¨å¯«æ¸¬è©¦

---

### æ’‡æ­¥ 4: æ‰¹é‡æ¸¬è©¦ç•°å¸¸è™•ç†

**å¿«é€Ÿæ–¹æ³•**: ç‚ºæ‰€æœ‰ try-catch æ·»åŠ ç•°å¸¸æ¸¬è©¦

```java
// æ¨¡æ¿ï¼šæ¸¬è©¦ç•°å¸¸åˆ†æ”¯
@Test
void testMethodName_ExceptionHandling() throws Exception {
    // è¨­ç½®æœƒå°è‡´ç•°å¸¸çš„æ¢ä»¶
    setupExceptionCondition();
    
    // èª¿ç”¨æ–¹æ³•
    assertDoesNotThrow(() -> {
        methodUnderTest();
    });
    
    // é©—è­‰ç•°å¸¸è¢«æ­£ç¢ºè™•ç†ï¼ˆä¾‹å¦‚ï¼šå»£æ’­éŒ¯èª¤è¨Šæ¯ï¼‰
    verifyErrorHandling();
}
```

---

### æ’‡æ­¥ 5: æ¸¬è©¦æ‰€æœ‰ if-else çš„ else åˆ†æ”¯

**é—œéµ**: å¾ˆå¤šåˆ†æ”¯æœªè¦†è“‹æ˜¯å› ç‚ºåªæ¸¬è©¦äº† `if`ï¼Œæ²’æ¸¬è©¦ `else`

```java
// ç¯„ä¾‹ï¼šæ¸¬è©¦ else åˆ†æ”¯
@Test
void testResolveDiscard_NoActions() {
    // è¨­ç½®æ¢ä»¶ï¼šæ²’æœ‰å¯ç”¨å‹•ä½œ
    setupNoActions();
    
    // åŸ·è¡Œ
    resolveDiscard(tile, playerIndex);
    
    // é©—è­‰ else åˆ†æ”¯è¢«åŸ·è¡Œ
    verifyNoActionGroupCreated();
}
```

---

## ğŸ“ å…·é«”æ”¹é€²è¨ˆåŠƒ

### Phase 1: WebSocketGameSession ç•°å¸¸è™•ç†ï¼ˆé è¨ˆ +15 åˆ†æ”¯ï¼‰

**ç›®æ¨™**: æ¸¬è©¦æ‰€æœ‰ catch åˆ†æ”¯

**æ¸¬è©¦æ–‡ä»¶**: `WebSocketGameSessionExceptionTest.java`

```java
// éœ€è¦æ¸¬è©¦çš„ç•°å¸¸åˆ†æ”¯ï¼š
1. performHu() - catch Exception
2. performKong() - catch Exception  
3. performConcealedKong() - catch Exception
4. performPong() - catch Exception
5. performChow() - catch Exception
6. startTurn() - catch Exception
7. resolveDiscard() - å¯èƒ½çš„ç•°å¸¸æƒ…æ³
```

---

### Phase 2: WebSocketGameSession Null æª¢æŸ¥ï¼ˆé è¨ˆ +10 åˆ†æ”¯ï¼‰

**ç›®æ¨™**: æ¸¬è©¦æ‰€æœ‰ null æª¢æŸ¥åˆ†æ”¯

```java
// éœ€è¦æ¸¬è©¦çš„ null åˆ†æ”¯ï¼š
1. if (currentActionGroup != null) - false åˆ†æ”¯
2. if (pendingDiscardTile != null) - false åˆ†æ”¯
3. if (replacement != null) - false åˆ†æ”¯ï¼ˆè£œç‰Œç‚º nullï¼‰
4. if (drawn != null) - false åˆ†æ”¯ï¼ˆæŠ½ç‰Œç‚º nullï¼‰
5. if (tile != null) - false åˆ†æ”¯
```

---

### Phase 3: WebSocketGameSession é‚Šç•Œæ¢ä»¶ï¼ˆé è¨ˆ +12 åˆ†æ”¯ï¼‰

**ç›®æ¨™**: æ¸¬è©¦æ‰€æœ‰é‚Šç•Œæ¢ä»¶

```java
// éœ€è¦æ¸¬è©¦çš„é‚Šç•Œæ¢ä»¶ï¼š
1. if (totalTiles == 14) - true/false
2. if (totalTiles == 17) - true/false
3. if (sea.isEmpty()) - true/false
4. if (pendingResponses.isEmpty()) - true/false
5. if (concealedKongOptions.isEmpty()) - true/false
6. if (allActions.isEmpty()) - true/false
```

---

### Phase 4: WebSocketGameSession ç‹€æ…‹çµ„åˆï¼ˆé è¨ˆ +20 åˆ†æ”¯ï¼‰

**ç›®æ¨™**: æ¸¬è©¦æ‰€æœ‰ç‹€æ…‹çµ„åˆ

```java
// éœ€è¦æ¸¬è©¦çš„ç‹€æ…‹çµ„åˆï¼š
1. waitingForAction = true/false çš„å„ç¨®çµ„åˆ
2. isFirstTurn = true/false çš„çµ„åˆ
3. currentActionGroup.priority çš„ä¸åŒå€¼ (0, 1, 2, 3)
4. playerIndex == currentPlayerIndex çš„å„ç¨®æƒ…æ³
5. canTsumo = true/false çš„çµ„åˆ
```

---

### Phase 5: å…¶ä»–é¡åˆ¥å¿«é€Ÿæå‡ï¼ˆé è¨ˆ +30 åˆ†æ”¯ï¼‰

#### WinStrategy (33 æœªè¦†è“‹åˆ†æ”¯)
- æ¸¬è©¦æ‰€æœ‰ç²å‹æ¢ä»¶çš„ false åˆ†æ”¯
- æ¸¬è©¦ç‰¹æ®Šç‰Œå‹çµ„åˆ

#### ScoringCalculator (23 æœªè¦†è“‹åˆ†æ”¯)
- æ¸¬è©¦æ‰€æœ‰è¨ˆåˆ†è¦å‰‡çš„é‚Šç•Œæ¢ä»¶
- æ¸¬è©¦ç‰¹æ®Šæƒ…æ³ï¼ˆä¾‹å¦‚ï¼šç„¡åˆ†æ•¸ï¼‰

#### PlayerHand (13 æœªè¦†è“‹åˆ†æ”¯)
- æ¸¬è©¦æ‰€æœ‰æ–¹æ³•çš„é‚Šç•Œæ¢ä»¶
- æ¸¬è©¦ç•°å¸¸è¼¸å…¥

---

## ğŸš€ å¿«é€ŸåŸ·è¡Œè¨ˆåŠƒï¼ˆé è¨ˆ 2-3 å°æ™‚ï¼‰

### Step 1: å‰µå»ºç•°å¸¸æ¸¬è©¦æ–‡ä»¶ï¼ˆ30 åˆ†é˜ï¼‰
- å‰µå»º `WebSocketGameSessionExceptionTest.java`
- ç‚ºæ‰€æœ‰ try-catch æ·»åŠ æ¸¬è©¦

### Step 2: è£œå…… Null æª¢æŸ¥æ¸¬è©¦ï¼ˆ30 åˆ†é˜ï¼‰
- åœ¨ç¾æœ‰æ¸¬è©¦æ–‡ä»¶ä¸­æ·»åŠ  null åˆ†æ”¯æ¸¬è©¦
- é‡é»ï¼š`pendingDiscardTile == null`, `replacement == null`

### Step 3: è£œå……é‚Šç•Œæ¢ä»¶æ¸¬è©¦ï¼ˆ45 åˆ†é˜ï¼‰
- æ¸¬è©¦æ‰€æœ‰ `isEmpty()` æª¢æŸ¥
- æ¸¬è©¦æ‰€æœ‰ `==` æ¯”è¼ƒçš„ false åˆ†æ”¯

### Step 4: è£œå……ç‹€æ…‹çµ„åˆæ¸¬è©¦ï¼ˆ60 åˆ†é˜ï¼‰
- æ¸¬è©¦ `waitingForAction` çš„å„ç¨®çµ„åˆ
- æ¸¬è©¦ `isFirstTurn` çš„å„ç¨®æƒ…æ³
- æ¸¬è©¦ `priority` çš„ä¸åŒå€¼

### Step 5: é‹è¡Œæ¸¬è©¦ä¸¦é©—è­‰ï¼ˆ15 åˆ†é˜ï¼‰
- é‹è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶
- æª¢æŸ¥è¦†è“‹ç‡å ±å‘Š
- ç¢ºèªé”åˆ° 80%

---

## ğŸ’¡ å¯¦ç”¨æŠ€å·§

### æŠ€å·§ 1: ä½¿ç”¨åå°„æ¸¬è©¦ç§æœ‰æ–¹æ³•
```java
Method method = WebSocketGameSession.class.getDeclaredMethod("methodName", ...);
method.setAccessible(true);
method.invoke(session, ...);
```

### æŠ€å·§ 2: ä½¿ç”¨ Mockito æ¨¡æ“¬ç•°å¸¸
```java
when(mockObject.method()).thenThrow(new Exception("Test exception"));
```

### æŠ€å·§ 3: æ‰¹é‡è¨­ç½®æ¸¬è©¦æ•¸æ“š
```java
// å‰µå»ºè¼”åŠ©æ–¹æ³•å¿«é€Ÿè¨­ç½®æ¸¬è©¦å ´æ™¯
private void setupScenario(String scenarioName) {
    switch(scenarioName) {
        case "null_replacement":
            // è¨­ç½®è£œç‰Œç‚º null çš„å ´æ™¯
            break;
        case "empty_actions":
            // è¨­ç½®ç„¡å¯ç”¨å‹•ä½œçš„å ´æ™¯
            break;
        // ...
    }
}
```

### æŠ€å·§ 4: ä½¿ç”¨åƒæ•¸åŒ–æ¸¬è©¦
```java
@ParameterizedTest
@ValueSource(booleans = {true, false})
void testWithDifferentStates(boolean waitingForAction) {
    // æ¸¬è©¦ä¸åŒç‹€æ…‹
}
```

---

## ğŸ“ˆ é æœŸçµæœ

å®Œæˆä»¥ä¸Šè¨ˆåŠƒå¾Œï¼Œé æœŸè¦†è“‹ç‡ï¼š

- **WebSocketGameSession**: 44% â†’ **65%+** (+57 åˆ†æ”¯)
- **æ•´é«”åˆ†æ”¯è¦†è“‹ç‡**: 66% â†’ **80%+** (+87 åˆ†æ”¯)

---

## âœ… æª¢æŸ¥æ¸…å–®

- [ ] Phase 1: ç•°å¸¸è™•ç†æ¸¬è©¦å®Œæˆ
- [ ] Phase 2: Null æª¢æŸ¥æ¸¬è©¦å®Œæˆ
- [ ] Phase 3: é‚Šç•Œæ¢ä»¶æ¸¬è©¦å®Œæˆ
- [ ] Phase 4: ç‹€æ…‹çµ„åˆæ¸¬è©¦å®Œæˆ
- [ ] Phase 5: å…¶ä»–é¡åˆ¥æ¸¬è©¦å®Œæˆ
- [ ] é‹è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶
- [ ] é©—è­‰è¦†è“‹ç‡é”åˆ° 80%
- [ ] æ›´æ–°æ¸¬è©¦å ±å‘Š

---

## ğŸ¯ å„ªå…ˆç´šå»ºè­°

**å¦‚æœæ™‚é–“æœ‰é™ï¼ŒæŒ‰æ­¤é †åºåŸ·è¡Œ**ï¼š

1. **æœ€é«˜å„ªå…ˆç´š**: Phase 1 (ç•°å¸¸è™•ç†) - æœ€å®¹æ˜“å¯¦ç¾ï¼Œæ”¶ç›Šé«˜
2. **é«˜å„ªå…ˆç´š**: Phase 2 (Null æª¢æŸ¥) - ç°¡å–®ï¼Œè¦†è“‹å¤šå€‹åˆ†æ”¯
3. **ä¸­å„ªå…ˆç´š**: Phase 3 (é‚Šç•Œæ¢ä»¶) - éœ€è¦æ›´å¤šè¨­ç½®
4. **ä½å„ªå…ˆç´š**: Phase 4 (ç‹€æ…‹çµ„åˆ) - è¤‡é›œä½†é‡è¦
5. **å¯é¸**: Phase 5 (å…¶ä»–é¡åˆ¥) - å¦‚æœå‰ 4 éšæ®µå·²é” 80%

---

**é–‹å§‹åŸ·è¡Œ**: å»ºè­°å¾ Phase 1 é–‹å§‹ï¼Œé€™æ˜¯æœ€å¿«è¦‹æ•ˆçš„æ–¹æ³•ï¼

